<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0, private">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Last-Modified" content="0">
    <meta name="cache-control" content="no-cache">
    <meta name="expires" content="0">
    <title>Desktop</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'mac-gray': '#c0c0c0',
                        'mac-dark-gray': '#808080',
                        'mac-light-gray': '#e0e0e0',
                        'mac-white': '#ffffff',
                        'mac-black': '#000000',
                    },
                    fontFamily: {
                        'chicago': ['Chicago', 'Geneva', 'monospace'],
                        'geneva': ['Geneva', 'monospace'],
                    },
                }
            }
        }
    </script>
    
    <!-- Custom Retro CSS - Split into modules -->
    <script>
        const cacheBuster = '?v=7&t=' + Date.now() + '&r=' + Math.random();
        document.write('<link rel="stylesheet" href="css/desktop.css' + cacheBuster + '">');
        document.write('<link rel="stylesheet" href="css/window.css' + cacheBuster + '">');
        document.write('<link rel="stylesheet" href="css/cursor.css' + cacheBuster + '">');
        document.write('<link rel="stylesheet" href="css/apps.css' + cacheBuster + '">');
    </script>
</head>
<body class="desktop-body">
    <!-- Global Menu Bar (Always Visible) -->
    <nav class="desktop-menubar">
        <div class="mac-menu-item mac-menu-dropdown" id="desktop-file-menu">
            <span>File</span>
            <div class="mac-dropdown" id="desktop-file-dropdown">
                <div class="mac-dropdown-item" id="export-data">Export Data</div>
                <div class="mac-dropdown-item-separator"></div>
                <div class="mac-dropdown-item" id="import-data">Import Data</div>
            </div>
        </div>
        <div class="mac-menu-item">
            <span>Edit</span>
        </div>
        <div class="mac-menu-item">
            <span>View</span>
        </div>
        <div class="mac-menu-item">
            <span>Label</span>
        </div>
        <div class="mac-menu-item mac-menu-dropdown" id="desktop-special-menu">
            <span>Special</span>
            <div class="mac-dropdown" id="desktop-special-dropdown">
                <div class="mac-dropdown-item" id="show-desktop">Show Desktop</div>
                <div class="mac-dropdown-item" id="close-all-windows">Close All Windows</div>
                <div class="mac-dropdown-item" id="logout" style="border-top: 1px solid #808080; margin-top: 4px; padding-top: 8px;">Log Out</div>
            </div>
        </div>
    </nav>

    <!-- Desktop Wallpaper -->
    <div class="desktop-wallpaper">
        <!-- Desktop Icons -->
        <div class="desktop-icons">
            <!-- Pomodoro Timer Icon -->
            <div class="desktop-icon" data-app="pomodoro">
                <div class="icon-graphic">
                    <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
                        <!-- Clock icon -->
                        <circle cx="16" cy="16" r="12" fill="#ffffff" stroke="#000000" stroke-width="1"/>
                        <line x1="16" y1="16" x2="16" y2="8" stroke="#000000" stroke-width="1.5" stroke-linecap="square"/>
                        <line x1="16" y1="16" x2="20" y2="16" stroke="#000000" stroke-width="1.5" stroke-linecap="square"/>
                        <circle cx="16" cy="16" r="1.5" fill="#000000"/>
                    </svg>
                </div>
                <div class="icon-label">Pomodoro</div>
            </div>

            <!-- Task Management Icon -->
            <div class="desktop-icon" data-app="todo">
                <div class="icon-graphic">
                    <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
                        <!-- Document with checkmark -->
                        <rect x="6" y="4" width="14" height="20" fill="#ffffff" stroke="#000000" stroke-width="1"/>
                        <rect x="8" y="8" width="10" height="1.5" fill="#000000"/>
                        <rect x="8" y="11" width="10" height="1.5" fill="#000000"/>
                        <rect x="8" y="14" width="7" height="1.5" fill="#000000"/>
                        <!-- Checkmark -->
                        <line x1="20" y1="10" x2="22" y2="12" stroke="#000000" stroke-width="1.5" stroke-linecap="square"/>
                        <line x1="22" y1="12" x2="24" y2="8" stroke="#000000" stroke-width="1.5" stroke-linecap="square"/>
                    </svg>
                </div>
                <div class="icon-label">Tasks</div>
            </div>

            <!-- Dashboard Icon -->
            <div class="desktop-icon" data-app="dashboard">
                <div class="icon-graphic">
                    <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
                        <!-- Chart/graph icon -->
                        <rect x="4" y="20" width="4" height="8" fill="#ffffff" stroke="#000000" stroke-width="1"/>
                        <rect x="10" y="16" width="4" height="12" fill="#ffffff" stroke="#000000" stroke-width="1"/>
                        <rect x="16" y="12" width="4" height="16" fill="#ffffff" stroke="#000000" stroke-width="1"/>
                        <rect x="22" y="8" width="4" height="20" fill="#ffffff" stroke="#000000" stroke-width="1"/>
                        <!-- Base line -->
                        <line x1="4" y1="28" x2="26" y2="28" stroke="#000000" stroke-width="1"/>
                    </svg>
                </div>
                <div class="icon-label">Dashboard</div>
            </div>

            <!-- Folder Icon -->
            <div class="desktop-icon" data-app="folder">
                <div class="icon-graphic">
                    <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
                        <!-- Classic Mac folder -->
                        <!-- Folder tab -->
                        <rect x="6" y="6" width="10" height="4" fill="#ffffff" stroke="#000000" stroke-width="1"/>
                        <rect x="8" y="8" width="6" height="2" fill="#000000"/>
                        <!-- Folder body -->
                        <rect x="6" y="10" width="20" height="18" fill="#ffffff" stroke="#000000" stroke-width="1"/>
                        <!-- Folder highlight -->
                        <rect x="8" y="12" width="16" height="1" fill="#000000"/>
                        <rect x="8" y="14" width="16" height="1" fill="#000000"/>
                        <rect x="8" y="16" width="12" height="1" fill="#000000"/>
                    </svg>
                </div>
                <div class="icon-label">Folder</div>
            </div>

            <!-- Auth Icon -->
            <div class="desktop-icon" data-app="auth">
                <div class="icon-graphic">
                    <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
                        <!-- Key/Lock icon -->
                        <rect x="10" y="12" width="12" height="10" fill="#ffffff" stroke="#000000" stroke-width="1"/>
                        <circle cx="16" cy="12" r="4" fill="#ffffff" stroke="#000000" stroke-width="1"/>
                        <rect x="15" y="10" width="2" height="4" fill="#000000"/>
                        <rect x="14" y="18" width="4" height="2" fill="#000000"/>
                    </svg>
                </div>
                <div class="icon-label">Auth</div>
            </div>

            <!-- Trash Icon -->
            <div class="desktop-icon" data-app="trash">
                <div class="icon-graphic">
                    <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
                        <!-- Trash can icon -->
                        <rect x="10" y="6" width="12" height="2" fill="#000000"/>
                        <rect x="12" y="8" width="8" height="18" fill="#ffffff" stroke="#000000" stroke-width="1"/>
                        <rect x="14" y="10" width="4" height="1.5" fill="#000000"/>
                        <rect x="14" y="13" width="4" height="1.5" fill="#000000"/>
                        <rect x="14" y="16" width="4" height="1.5" fill="#000000"/>
                        <rect x="15" y="24" width="2" height="2" fill="#000000"/>
                    </svg>
                </div>
                <div class="icon-label">Trash</div>
            </div>
        </div>
        <!-- App Windows Container -->
        <div id="windows-container" class="windows-container"></div>
    </div>

    <!-- Custom Cursor - Pixelated Apple System 1.0 -->
    <div id="custom-cursor" class="mac-cursor mac-cursor-normal">
        <!-- Cursor image loaded from cursors folder -->
        <img id="cursor-svg" src="assets/cursors/Normal Select.cur" alt="cursor" width="16" height="16">
    </div>
    
    <script type="module">
        // Check authentication before loading desktop
        import { CONFIG } from './js/config.js';
        
        async function checkAuthBeforeLoad() {
            const token = localStorage.getItem(CONFIG.STORAGE.AUTH_TOKEN);
            
            // If no token, redirect to auth
            if (!token) {
                console.log('No auth token found, redirecting to auth...');
                window.location.href = 'apps/auth.html';
                return;
            }
            
            // Verify token with backend
            try {
                const response = await fetch(`${CONFIG.API.BASE_URL}${CONFIG.API.ENDPOINTS.AUTH.ME}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    // Token invalid, clear and redirect to auth
                    console.log('Token invalid, redirecting to auth...');
                    localStorage.removeItem(CONFIG.STORAGE.AUTH_TOKEN);
                    localStorage.removeItem(CONFIG.STORAGE.CURRENT_USER);
                    window.location.href = 'apps/auth.html';
                    return;
                }
                
                // Authenticated, load desktop
                console.log('Authentication verified, loading desktop...');
                
                // Register service worker for offline support
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js')
                        .then((registration) => {
                            console.log('Service Worker registered:', registration);
                        })
                        .catch((error) => {
                            console.warn('Service Worker registration failed:', error);
                        });
                }
                
                const script = document.createElement('script');
                script.type = 'module';
                script.src = 'js/desktop.js?v=7&t=' + Date.now() + '&r=' + Math.random();
                document.body.appendChild(script);
                
            } catch (error) {
                // If we can't verify auth, force auth page first (security + consistent UX)
                console.warn('Auth check failed, redirecting to auth:', error);
                window.location.href = 'apps/auth.html';
            }
        }
        
        // Run auth check
        checkAuthBeforeLoad();
        
        // Add error handling for module loading
        window.addEventListener('error', (event) => {
            if (event.filename && event.filename.includes('.js')) {
                console.error('Failed to load module:', event.filename, event.error);
            }
        });

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
        });
    </script>
</body>
</html>

